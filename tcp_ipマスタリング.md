# 1.ネットワーク基礎知識  
## 1.1 コンピュータネットワーク登場の背景  
### 1.1.2 スタンドアロンからネットワーク利用へ  
コンピュータは単体(スタンドアロン)で使われていた、サーバーというものがない時代  
そこから、複数のコンピュータを接続したコンピュータ・ネットワークが誕生した  
## 1.2 コンピュータとネットワーク発展の7つの段階
### 1.2.1 バッチ処理  
多くの人にコンピュータが利用されるには、バッチ処理形式のコンピュータが必要だった  
コンピュータを扱う専門のオペレータに依頼するフローだった  
バッチ処理形式のコンピュータは使い勝手がいいものではなく、誰もが手軽に扱えるものではなかった  
### 1.2.2 タイムシェアリングシステム(TSS)  
TSSは、バッチ処理形式の次に登場したもの  
TSSで、コンピュータとインタラクティブ（対話的）な操作が可能になった  
コンピュータと対話的にプログラミングできるのがBASIC  
バッチ形式だった時代はCOBOL、FORTRAN  
BASICはTSSを意識した初心者向けの言語で、より多くの人にプログラミングを学習してもらうために開発された  
### 1.2.3 コンピュータ通信  
TSSでコンピュータと端末がつながっているだけでコンピュータ同士が接続されたわけではない  
1970年代になるとコンピュータの性能が飛躍的に向上して、価格も安くなり一般企業もコンピュータを導入するようになった  
コンピュータ間通信が可能になると、ハードウェアの記憶媒体にデータを保管せずともデータのやり取りが簡単になり、手間も少なくなった  
### 1.2.4 コンピュータネットワークの登場  
- 1970年代の初期にはパケット交換技術によるコンピュータネットワークの実験が開始され、異なるメーカーのコンピュータ同士でも相互通信を可能にする技術が研究されるようになった  
- 1980年代にはそれが実現したコンピュータネットワークが誕生  
### 1.2.5 インターネットの普及  
1990年代になると一人一台のコンピュータを持つようになり、ダウンサイジング、マルチベンダ接続（異機種間接続）という言葉が流行した  
  マルチベンダ接続のために使われたのがインターネットの通信技術だった  
#### ダウンサイジング  
1990年代前半パソコンやUNIXワークステーションの性能はそれまでのメインフレームワーク(機関情報システムなどに使用される大型コンピュータを指す)と変わらないくらいの能力を持つようになった  
  大型のメインフレームで構築したシステムへ置き換える動きが活発化した、このような動きをダウンサイジングという ***  1.2.6 インターネット技術中心の時代へ  
  インターネットの普及と発展が通信のあらゆる分野に影響を与えた  
  インターネットは別々に発展してきた多くの技術をすべてインターネットに取り込む方向に進んでいく  
  汎用の通信基盤として電話網の代わりに **インターネットの技術でもあるIP網** が利用され、その上で電話やテレビ放送、コンピュータ通信、インターネットが構築されている  
  ネットワークにつながる機器も、いわゆる「コンピュータ」だけではなく携帯端末や家電製品、ゲーム機などに広がった  
  インターネットとの接続を前提としない制御システムの分野でもIPが使われている(たとえば火力発電所のボイラー制御)  
### 1.2.8 人からモノへ、モノからコトへ  
コンピュータネットワークの目的は「生産性の向上」であるといえる  
  しかし、今ではその目的が少しずつ変わってきている  
  今後はインターネットの利活用が更に進み、色々なモノへ接続され、そこから得られた情報をもとに新たなコトを創造する仕組みが増えていく  
  インターネットは第4次産業革命ともいわれている  
### 1.2.9 すべての鍵を握るTCP/IP  
TCP/IPとは通信プロトコルの総称  
  「プロトコル」についてきちんと理解しよう！  
## 1.3 プロトコルとは  
### 1.3.1 プロトコルがいっぱい  
さまざまなプロトコルを体系的にまとめたものを「ネットワークアーキテクチャ」ということがある  
### 1.3.5 パケット交換でのプロトコル  
パケットは辞書で調べると「小包」、まさに大きなデータを小包に小分けして相手に届けている  
  自分のアドレスや宛先のアドレス、データの番号などが書かれている部分をパケットのヘッダという  
  大きなデータをパケットに分けて通信したとき、元データのどの部分なのかを示す番号がついている  
  その番号を元に受け取り側はパケットのデータを元データに組み上げることができる  
## 1.4 プロトコルは誰が決める？  
### 1.4.1 コンピュータ通信の登場から標準化へ  
1974年にIBMがコンピュータ通信技術を体系化したネットワークアーキテクチャ、SNAを発表  
  その後、各コンピュータメーカーはそれぞれの独自ネットワークアーキテクチャを発表し、プロトコル群の体系化を図った  
  そうすると各ネットワークアーキテクチャは互換性がないので、通信するためには同じメーカーのコンピュータを揃えないといけないかつずっとそのメーカのコンピュータを買い続けないといけない  
  そこでネットワークのオープン化、マルチベンダ化である  
  異なるメーカーのコンピュータでも自由に通信できる環境が強く望まれた  
### 1.4.2 プロトコルの標準化  
このような問題を解決するためにISO（国際標準化機構）は国際基準としてOSI(開放型システム間相互接続)と呼ばれる通信体系を標準化した  
  現在OSIの定めるプロトコルは普及していないが、OSIプロトコルを設計する際の指針として提唱されたOSI参照モデルはネットワークプロトコルを考えるときによく引き合いに出される  
  本書のTCP/IPはISOの国際標準ではない、TCP/IPはIETF（Internal Engineering Task Force）で提案や標準化作業が行われているプロトコルである  
  大学などの研究機関やコンピュータ業界が中心となって標準化が推進され、発展してきた  
  TCP/IPはインターネット上の標準であり、デファクトスタンダードとして世界中で最も広く使われている通信プロトコル  
  インターネットで利用される機器やソフトウェアは、IETFによって標準化されたTCP/IPに準拠している  
  標準化によってコンピュータネットワークは便利なものになった  
## 1.5 プロトコルの階層化とOSI参照モデル  
### 1.5.1 プロトコルの階層化  
通信プロトコルを設計するさいに、OSI参照モデル(通信に必要な機能を7つの階層に分けることで、単純化するためのモデル)を提唱した  
  各階層は上の層と下位層の間でサービスのやりとりをする約束事を **インターフェース** とよび、通信相手の同じ階層とやりとりするをするときの約束事を **プロトコル** とした  
  この階層化は開発のモジュール化（ある機能を実行するかたまりをモジュールと呼び、それを開発時の部品として利用する）  
### 1.5.3 OSI参照モデル  
OSI参照モデルはあくまでも **モデル** であり、プロトコルやインターフェースの詳細を決めているわけではない、プロトコルの設計や勉強をするときのガイドライン  
### 1.5.4 OSI参照モデルの各層の役割  
1. アプリケーション層  
   アプリケーションの中の通信に関する部分を定めている  
2. プレゼンテーション層  
   上位層・下位層それぞれに通信に適したデータフォーマットに変換することに責任を持つ  
   具体的には機器固有のデータフォーマットなどをネットワーク共通のフォーマットに変換する役割  
   機器の違いによる整合性をとる  
3. セッション層  
   コネクション（データの流れる論理経路）の確立や切断、転送するデータの切れ目の設定やなどデータ転送の管理  
4. トランスポート層  
   宛先のアプリケーションにデータを確実に届ける役割  
   通信を行う両端のノードだけで処理され、途中のルーターでは処理されない  
5. ネットワーク層  
   宛先までデータを届ける役割  
   宛先はネットワークが複数のルーターでつながった遠い場所の可能性もあるので、アドレスの体系決め、どの経路使うかの判断をしている  
6. データリンク層  
   物理層で直接接続されたノード間（例えば１つのイーサネットに接続された２つのコンピュータ）での通信を可能にする  
7. 物理層  
   ビット列のデータを電圧の高低や光の明滅に変換したり、その逆もする  
## 1.6 OSI参照モデルによる通信処理の例  
**ホスト**  
   本書ではネットワークに接続されたコンピュータと言う意味で使っている  
   (OSIではノードという)  
### 1.6.2 セッション層以上での処理  
プレゼンテーション層はネットワーク共通のフォーマットに変換している層なので、受け取ったメッセージが文字化けしているとプレゼンテーション層の設定がうまくいっていないことになる  
   ネットワーク層もデータリンク層もデータを送るプロトコルだが、ネットワーク層はゴールの宛先まで届ける役割をもっていてデータリンク層は1区間のデータを転送する  
## 1.8 アドレスとは  
### 1.8.2 アドレスの階層性  
MACアドレスの場合、参照するアドレス対応表を **フォワーディングテーブル**  
   IPアドレスの場合、**ルーティングテーブル** をみて、次のデータの転送先を判断している  
## 1.9 ネットワークの構成要素  
- **ネットワークインターフェース**  
  コンピュータをネットワークに接続するための装置  
- **リピーター**  
  ネットワークを物理層で延長する  
- **ブリッジ/レイヤ２スイッチ**  
  ネットワークをデータリンク層で延長する  
- **ルーター /レイヤ３スイッチ**  
  ネットワーク層によってパケットを転送する  
- **レイヤ4-7スイッチ**  
  トランスポート層より上の層でトラフィックを処理する  
- **ゲートウェイ**  
  プロトコルの変換をする  
### 1.9.4 ブリッジ/レイヤ２スイッチ  
- **フレーム**  
  パケットとほぼ同じ意味。データリンクではフレームと表現する  
- **セグメント**  
  分割、区分といったネットワークを指して使われる  
  またTCPでのデータを表す意味にも使われる  
- **トラフィック**  
  ネットワーク上を流れるパケットやパケットの量を表す  
  ブリッジの機能を持ったハブを **スイッチ(ングハブ)** と呼ぶ  
### 1.9.5 ルーター/レイヤ３スイッチ  
ルーターはネットワークとネットワークを接続して、パケットを中継する機器  
  異なるデータリンク同士を接続することができる  
  家のネット環境を構築するために置いてある小箱は **ブロードバンドルーター** や **CPE** というルーターの一種  

# 2.TCP/IP 基礎知識  
## TCP/IP 登場の背景とその歴史  
なぜネットワークの基盤にTCP/IPが起用されるようになったのか？  
### 2.1.1 軍事技術の応用から  
DoD(アメリカ国防省)が中心となり進められた研究開発があり、それが **パケット通信**  
なぜなら、軍事的な視点で分散型のネットワークであれば、一つの拠点が攻撃されても迂回路がある限りは通信が可能であるから  
さらに、パケット通信であれば複数のユーザが一つの回線を利用する形が取れるので、回線コストを下げられる  
### 2.1.2 ARPANETの誕生  
1969年、当初のネットワークはアメリカ西海岸の大学と研究機関のうちの４つのノードを結んだものだった  
このネットワークはDoDが中心となって開発が行われたことや、技術が飛躍的に進歩していったことにより、一般のユーザーも取り込んで当時としては非常に大規模なネットワークに発達していった  
これを **ARPANET** (Advanced Research Projects Agency Network: アーパネットと発音)といい、インターネットの起源と言われている  
これがわずか３年で４つのノードから３４のノードを接続する形に発展し、この実験は大成功し、パケットによるデータ通信手法が実用的だということが証明された  
### 2.1.3 TCP/IPの誕生  
そして、1970年代前半にTCP/IPが開発され、1982年までかかってTCP/IPの仕様が決定され、翌年にはARPANETでつかう唯一のプロトコルになった  
### 2.1.4 UNIXの普及とインターネットの拡大  
ARPANETがTCP/IPの要だったのは事実だが、世界的に広く普及した理由はそこじゃなかった  
1980年前後の大学や研究所でコンピュータのOSとしてBSD UNIXが広く利用されていて、その内部にTCP/IPが実装されたことだった  
## 2.2 TCP/IPの標準化  
なぜOSIではなく、TCP/IPが標準化されたのか  
### 2.2.1 TCP/IPという語は何を指す？  
実際にTCP/IPはインターネットプロトコルスイートと呼ばれ、インターネットを構築するうえで必要なプロトコルのセットという意味である  
### 2.2.2 TCP/IP標準化の精神  
1. 議論の場がオープンである  
2. プロトコルの仕様を決めることを重視するのではなく、互いに通信できる技術を追い求めてきたということ  
### 2.2.3 TCP/IPの仕様書 RFC  
標準化しようとするプロトコルは、RFC(Request For Comments)のドキュメントになる  
## 2.3 インターネットの基礎知識  
### 2.3.3 インターネットの構造  
巨大なネットワークは階層的になっていて、小さなネットワーク同士が接続されることで大きなネットワークを形成している  
   ネットワーク同士は **NOC** で接続される  
   ネットワークの運用者や利用方針が違うネットワークを対等に接続するポイントは **IX** と呼ばれる  
## 2.4 TCP/IPの階層モデル  
- アプリケーション層 (OSI参照モデルでいうと4-7レイヤ)  
- トランスポート層 (OSI参照モデルでいうとトランスポート層)  
- インターネット層（OSI参照モデルでいうとネットワーク層）  
- ネットワークインターフェース層（OSI参照モデルでいうとデータリンク層）  
- ハードウェア) (OSI参照モデルでいうと物理層)  
  OSI参照モデルとTCP/IPの階層モデルがちがう理由はOSI参照モデルは「通信プロトコルに必要な機能はなにか」を中心に考えてモデル化されているのに対し、  
  TCP/IPの階層モデルは「プロトコルをコンピュータに実装するにはどのようにプログラミングしたらよいか」を中心に考えてモデル化されているため  
### 2.4.2 ハードウェア（物理層）  
TCP/IPはネットワークで接続された装置間(イーサネットだろうが無線だろうが通信媒体が何であるか気にしない)で通信できることを前提にして作られているプロトコル  
### 2.4.3 ネットワークインターフェース層（データリンク層）  
ネットワークインターフェース層は、イーサネットなどのデータリンクを利用して通信をするためのインターフェースとなる階層  
  つまりNICを動かすための **デバイスドライバ** と考えていい デバイスドライバはOSとハードウェアの橋渡しをするソフトウェアである  
### 2.4.4 インターネット層（ネットワーク層）  
インターネット層では、IPが使われている  
  IPはIPアドレスをもとにしてパケットを転送する  
#### IP (Internet Protocol)  
IPはパケット交換プロトコルだが、パケットが相手に到達しているかどうかは気にしないし再送もしない  
#### ICMP (Internet Control Message Protocol)  
IPパケットの配送中に何らかの異常があってパケットを転送できなかったとき、パケットの送信元に以上を知らせるために使われるプロトコル  
  ネットワークの診断などにも使われる  
#### ARP(Address Resolution Protocol)  
パケットの送り先の物理的なアドレス（MACアドレス）をIPアドレスから取得するプロトコル  
### 2.4.5 トランスポート層  
トランスポート層のもっとも重要な役割はアプリケーションプログラム間の通信を実現すること  
  どのプログラムとどのプログラムが通信しているのか識別するために **ポート番号** が使われている  
### 2.4.6 アプリケーション層  
TCP/IP階層モデルではセッション層、プレゼンテーション層、アプリケーション層はすべてアプリケーションプログラムの中で実現されると考えられている  
#### Webアクセス(www)  
wwwではHTTPがOSI参照モデルのアプリケーション層のプロトコル、HTMLがプレゼンテーション層はえのプロトコルといえる  
#### 電子メール（E-Mail）  
電子メールでよく使われるE-Mailは、electonic mailの略  
  当時、インターネットの電子メールでは、テキスト形式でしかメッセージを送信できなかった  
  現在は電子メールで送信できるデータフォーマットを拡張するMIMEの仕組みが一般的になり、映像や音声のファイルなどさまざまな情報を送ることができる  
  このMIMEははOSI参照モデルの第６層、プレゼンテーション層の機能ということができる  
#### 遠隔ログイン（TELNETとSSH）  
TCP/IPにおける遠隔ログインでは、TELNETプロトコルやSSHプロトコルがよく用いられている  
  また、BSD UNIX系のrloginなどのrコマンド系のプロトコルも利用される  
  X Window Systemで利用されるXプロトコルは、遠隔のグラフィック端末を実現するプロトコル  
  rlogin: RFC1283  
  Xプロトコル: RFC1198  
  同様にRemote Desktopもあるが、この場合はRDPが使われていて、それはRFCで規定されているものではない  
#### ネットワーク管理（SNMP）  
TCP/IPではネットワーク管理のプロトコルでSNMPが使われている  
  SNMPでは管理されているルーター、ブリッジホストなどは **エージェント** と呼ばれ、管理しているプログラムを **マネージャ** という  
  SNMPはエージェントとマネージャの通信プロトコル  
  SNMPのエージェントはネットワークインターフェースの情報や通信パケットの量、異常なパケットの量、機器の温度の情報などが格納されている  
  その情報にはMIB（Management Information Base）という決められた構造によってアクセスできる  
  SNMPや各種の動作ログを活用してネットワークの混雑具合の調査や障害の知見、将来のネットワーク拡張のための情報収集などに役立てられる  
## 2.5 TCP/IPの階層モデルと通信例  
### 2.5.1 パケットヘッダ  
#### パケット、フレーム、データグラム、セグメント、メッセージ  
- パケットは何にでも使える用語  
- フレームはデータリンクのパケットを表す  
- データグラムはIPやUDPなどネットワーク層以上でパケット単位のデータ構造を持つプロトコルで使用される  
- セグメントはストリームベースのTCPに含まれるデータを表すときに使用される  
- メッセージはアプリケーションプロトコルのデータ単位を表すときに使われる(これがSQSがメッセージとよんでいる所以？)  
#### ヘッダーはプロトコルの顔  
ネットワークを流れる（流れるって表現いいな）パケットはプロトコルが利用する **ヘッダ** と、そのプロトコルの上位層が利用する **データ** から構成されている  
  ヘッダの皇族は細かい部分まで明確に仕様が決められいてる  
  たとえば、上位プロトコルを識別するフィールドはどこに位置し、何ビットのフィールドを持っているかとか、チェックサムはどのような方法で計算してどこのフィールドにいれるかなどが、きちんと決められている  
  通信する双方のコンピュータで **プロトコルの識別番号やチェックサムの計算方法が違えば、まったく通信できなくなってしまう**  
  このように、パケットのヘッダにはそのプロトコルがどのように情報をやり取りするべきかが明確に表されている  
  逆に言えば、ヘッダを見ればその **プロトコルが 必要としている情報や処理内容が見えてくる**  
  つまり、パケットヘッダにはプロトコルの仕様が見に見える形で存在している  
  まさに **ヘッダはプロトコルの顔** といえる  
### 2.5.2 パケットの送信処理  
電子メールでTCP/IP上で「おはようございます」という文字列を２つのコンピュータ間でやり取りする場合を考えてみる  
1. アプリケーションの処理  
   送信ボタンを押すといよいよTCP/IPによる通信が開始される  
   まずアプリケーションプログラムでは、符号化の処理が行われる  
   たとえば、日本語の電子メールはISO-2022-JPやUTF-8といった規則に基づいて符号化されるが、それはOSIのプレゼンテーション層に相当する  
   アプリケーションはメール送信するとき、TCPにコネクションの確立を指示する  
   そして、TCPのコネクションが確立されたら、それを利用してメールデータの送信を行う  
   これにより、アプリケーションのデータが下位層のTCPに渡され、実際の転送処理が行われる  
2. TCPモジュールの処理  
   TCPは、アプリケーションの指示によって、コネクションを確立したり、データを送信したり、コネクションを確立したりする  
   TCPのヘッダは通信ホストと受信ホストのアプリケーションを識別するためのポート番号、データが壊れていないことを保証する **チェックサム** などが含まれている  
   そして、TCPヘッダを付けられたデータがIPに送られる  
3. IPモジュールの処理  
   IPではTCPから渡されたTCPヘッダ付きのデータを一つのデータとして扱う  
   そのデータのTCPヘッダの前にIPヘッダをつける  
   IPヘッダには宛先のIPアドレスや送信元のIPアドレス、IPヘッダのあとに続くデータがTCPなのか、UDPなのかといった情報が含まれている  
   IPパケットが完成したら、ルーティングテーブルを参照して、次に渡すルーターやホストを決定している  
   そして、その機器が接続されているネットワークインターフェースの **ドライバにIPパケットを渡して、実際の送信処理** をしてもらう  
4. ネットワークインターフェース（イーサネットドライバ）  
   IPから渡されたIPパケットは、イーサネットドライバにとっては単なるデータに過ぎない  
   このデータにイーサネットのヘッダをつけられて送信される  
   イーサネットのヘッダには、宛先のMACアドレスと送信元のMACアドレス、そしてイーサネットのヘッダに続くデータのプロトコルを示すイーサネットタイプが書き込まれる  
   以上の処理されたイーサネットのパケットが物理層により、相手先に送信される  
   送信処理中にFCS（Frame Check Sequence）がハードウェアで計算され、パケットの最後に付けられる  
   このFCSはノイズなどにより、データが壊れていないかを検出するためのものである  
### 2.5.3 データリンクを流れるパケットの様子  
パケットが流れるときには、パケットの最後にはイーサネットトレイラがつく  
### 2.5.4 パケットの受信処理  
受け取ったホストの処理は、送信ホストの処理と全く逆になる  
   ⑤  ネットワークインターフェース（イーサネットドライバ）の処理  
   イーサネットのバケットを受け取ったホストは、まずイーサネットヘッダの宛先MACアドレスが自分宛てかどうかを調べて、自分宛てではないパケットは捨てる  
   （多くのNIC製品で、自分宛てでないイーサネットのパケット（フレーム）を捨てないように設定することができる、これはネットワークのパケットのモニタリングを行う場合に利用される）  
   自分宛てのパケットを受け取ると、イーサネットタイプフィールドを調べて、イーサネットプロトコルが運んでいるデータの種類を調べる  
   この例ではIPなので、IPを処理するルーチン（決められた処理のプログラムを指す）にデータを渡す  
   ARなど他のプロトコルの場合にはそのルーチンにデータを渡すことになる  
   なお、処理できないプロトコルの値がイーサネットタイプフィールドに入っている場合はデータを捨てる  
   ⑥  IPモジュールの処理  
   IPのルーチンにIPヘッダ以降の部分が渡されると、そのままIPヘッダを処理する  
   宛先のIPアドレスが自分のホストのIPアドレスであればそのまま受信して上位層のプロトコルを調べる  
   そしてTCPならばTCPの処理ルーチンに、UDPならばUDPの処理ルーチンにIPヘッダを除いたデータの部分を送る  
   ルーターの場合は、受信するIPパケットの宛先は、ほとんど自分宛てではなく、この場合はルーティングテーブルから次に送るホストやルーターを調べて転送処理をすることになる  
   ⑦  TCPモジュールの処理  
   TCPではチェックサムを計算して、データが壊れていないかを確認する  
   そして、データを順番通りに受信しているかなどを確認する  
   また、ポート番号を調べて、通信しているアプリケーションを特定する  
   データがきちんと届いた場合にはデータが届いたことをホストに知らせるための **確認応答** を送信ホストに返す  
   この確認応答が送信したホストに届かなかったら、送信ホストは確認応答されるまで送信し続ける  
   データが正しく受信した場合、ポート番号で識別したアプリケーションへそのままデータを送る  
   ⑧  アプリケーションの処理  
   受信側のアプリケーションは渡されたデータをそのまま処理する  
   受信したデータを解析して、Bさん宛のメールだということを知る  
   受信したら、ハードディスクなどにメッセージを格納する  
   電子メールのすべてのメッセージを無事に格納できたら、処理が正常に終了したことを送信元のアプリケーションに伝える  
   途中でディスク容量を超えてメッセージを格納できなかった場合は異常終了のメッセージを送信する  
これでBさんはAさんからの「おはようございます」メールを読むことができる  
#### SNS(Social Network Service)での通信例  
SNSの通信の様子を見てみよう  
まずスマホなどの端末は **パケット通信をしている** ので、端末の電源を立ち上げて初期設定を行った時点で **通信会社よりIPアドレスが設定される**  
SNSアプリケーションを起動すると指定のサーバーに接続され、ユーザーIDやパスワードで認証を行い、サーバーに蓄積された情報が端末に送信されて端末上でその情報を表示する  
これらもTCP/IPを利用してやり取りされているので、追求したい場合はTCP/IPの知識が必要になる  

# 3.データリンク  
## 3.1データリンクの役割  
**データリンク** という言葉はOSI参照モデルのデータリンク層を指すときと、具体的な通信手段（イーサネット、無線LANなど）を指すときもある  
TCP/IPでは、OSI参照モデルのデータリンク層以下(データリンク層と物理層)を **定義していなくて** 、透過的に機能していることを前提にしている  
しかし、TCP/IPとネットワークの理解を深めるためにはデータリンクについての知識が重要になる  
データリンク層のプロトコルは、通信媒体で直接接続されている機器間で通信するための仕様を定めている  
通信媒体にはツイストペアケーブル（より対線）、同軸ケーブル、光ファイバー、電波、赤外線などがある  
また、機器間にスイッチやブリッジ、リピーターなどが中継するケースもある  
実際に通信するときは、コンピュータの情報は２進数で表されるが、通信媒体では **電圧の変化や光の点滅、電波の強弱** などである  
これらを２進数に変換するのは物理層で、データリンク層では単なる０と１の列ではなく、 **フレーム** という意味のあるかたまりにまとめて相手の機器に伝える  
フレームはパケットと同じ意味だが、連接するビット列を **わく** に区切るというニュアンスがある  
**データリンクのセグメント**
データリンクにおけるセグメントは **区切られた１つのネットワーク** を指すのに使われる
## 3.2 データリンクの技術
### 3.2.1 MACアドレス
MACアドレスは、データリンクに接続しているノードを識別するために利用される
### 3.2.4 MACアドレスによる転送
同軸ケーブル上で利用されるイーサネットなどの通信媒体を共有する方式では、同時に**１つのホストしか**データを送信できない  
そうなると、ネットワークに接続されるホストの数が多いと、通信性能が下がってしまう  
そこからハブやコンセントレートによってスター型で接続されると媒体非共有型で利用されていたスイッチ技術をイーサネットでも利用できるようになった  
これが**スイッチング・ハブ**や、**イーサネットスイッチ**と呼ばれるものである  
イーサネットスイッチは**複数のポートを持ったブリッジ**といえる  
これらデータリンク層における各フレームの通過点で、そのフレームの宛先MACアドレスをみてどのインタフェースから送るか決定する  
このときにフォワーディングテーブルを参照する  
ここでのポートはコンピュータ機器の外部インタフェースをポートと呼ぶ、TCP、UDPなどのトランスポートの**ポート**は別の意味でつかわれる  
MACアドレスはIPアドレスと違い階層性がないので、フォワーディングテーブルのエントリはそのデータリンク内に接続されている機器の数だけ必要になる  
### 3.2.5 ループを検出するための技術
ブリッジでネットワークをループさせると、最悪の場合同じフレームが大量にコピーされ、それが永久に回り続けいずれネットワークがメルトダウンさせてしまう  
そこで、そのループを解決するために**スパニングツリー方式**というものが考えられた  
スパニングツリーはブリッジにある機能
### 3.2.6 VLAN(Virtual LAN)
ネットワークを管理していると、人数の入れ替えなどがあると、ネットワークのトポロジーを変える必要がある  
そこで、普通はネットワークの配線を変えるのだが、VLANを使用できるブリッジ（スイッチ）を使えば、ネットワークの配線を変えずにネットワークの構造を変えることができる  
例えば、スイッチの**ポートごとに**セゲメントに分けることで、ブロードキャストのトラフィックが流れる範囲を区切ることができる  
## 3.4 無線通信
### 3.4.2 IEEE802.11
IEEE802.11は、無線LANプロトコルの物理層とデータリンク層の一部（MAC層）を定義した規格である
#### CSMA/CA
無線LANが利用する電波は有料である  
つまり、無線LANは複数の端末が同じ周波数帯を共有する必要がある媒体共有型のネットワーク  
IEEE802.11はCSMA/CAというアクセス制御方式を採用している  
これはCarrier Senseによりデータを送信して良い状態（**アイドル状態**と呼ぶ）かどうかを確認し、ランダムな時間（バックオフと呼ぶ）だけ待ってからデータ送信を開始することで衝突を回避する仕組み  
#### WPA2とWPA3
WPA2は、Wi-Fi Allianceの認証プログラムであるWPA（Wi-Fi Protected Access）を拡張したもの  
WPA3はWPA2のセキュリティ機能を更に拡張した規格である  
### 3.4.9 WiMAX
WiMAX（Worldwide Interoperabillity for Microwave Access）は、マイクロ波を使って企業や自宅への無線接続を行う方式である  
## 3.5 PPP(Point-to-Point Protocol)
### 3.5.1 PPPとは
PPP(Point-to-Point)は、その名の通り、ポイントツーポイント（1対1）でコンピュータを接続するためのプロトコルである  
PPPは、OSI参照モデルの第2層に相当するデータリンクプロトコルといえる  

# 4.IP(Internet Protocol)
## 4.1 IPはインターネット層のプロトコル
インターネット層はIPとICMP（Internet Control Message Protocol）の2つのプロトコルから構成されている  
### 4.1.1 IPはOSI基本参照モデルの第3層(ネットワーク層)に相当
ネットワーク層の役割は終端ノード間の通信を実現すること  
要は、異なるデータリンク同士も一つのネットワークとして連携させて、パケットを送信する、データリンク層よりも大規模なネットワークを管理する  
## 4.2 IPの基礎知識
異なるデータリンク同士を管理するので、ネットワーク層はデータリンク層の性質を抽象化する性質がある  
### 4.2.2 経路制御（ルーティング）
#### 最終的な宛先ホストまでのパケット配送
ホップ（hop）には「跳ぶ」という意味がある  
TCP/IPでは、ネットワークの1区間をIPパケットが跳ぶことをhopといい、この1区間を1ホップ(ワンホップ)という  
### 4.2.3 データリンクの抽象化
IPはデータリンクの抽象化をしている役割があるので当然、IPアドレスによってデータリンクのアドレスが抽象化される  
IPの上位層からは、実際の通信がイーサネットだろうが、無線LANだろうが、PPPだろうが同じように見えなければいけない  
**データリンクごとに異なる性質**の一つとして、最大転送単位（MTU: Maximum Transmission Unit）がある  
最大転送単位はトラックの最大積載量と考えればいい  
そうすると、MTUを超えるパケットがそのデータリンクに送られる問題が出てくる  
それを解決するためにIPでは分割処理(フラグメンテーションを行う)  
IPで小さいパケットに分けて、上位層にはその小さなパケット同士をつなげて渡す  
そうすることでデータリンクの抽象化が完成し、上位層がデータリンクの構造を知らなくても通信ができるようになる  
### 4.2.4 IPはコネクションレス型
IPはコネクションレス型である  
### 4.3.1 IPアドレスとは
実際のIPアドレスは、ホストごとではなく、NICごとに割り当てられる  
1つのNICに対して複数のIPアドレスをもたせることもできる  
ルーターは通常、NICを2つ以上持つから、2つ以上のIPアドレスをもつことになる  
IPアドレスは**ネットワーク部**と**ホスト部**にわかれるので、接続できるコンピュータの数はさらに少なくなる  
### 4.3.2 IPアドレスはネットワーク部とホスト部から構成される
**ネットワーク部**は、データリンクのセグメントごとに重複しない値を割り当てる  
同じセグメントに接続されているホストやルーターのNICには同じ値を割り当てる  
### 4.3.4 ブロードキャストアドレス
ブロードキャストアドレスは同一セグメントのホストすべてにパケットを送信するアドレスである  
IPアドレスのホスト部をすべて1にするとブロードキャストアドレスになる  
#### 2つのブロードキャスト
ブロードキャストにはローカルブロードキャストとダイレクトブロードキャストの2つがある  
自分が属しているリンク内のブロードキャストが、ローカルブロードキャストである  
このローカルブロードキャストはルーターで遮断されるので、ちがうリンクにパケットを送ることができない  
対して、ダイレクトブロードキャストは、異なるリンクへパケットを送るときにダイレクトブロードキャストアドレスが使える  
異なるネットワークに送れる＝セキュリティ上の問題があるので、ルーターで転送されないように設定されている事が多い  
### 4.3.5 IPマルチキャスト
マルチキャストは、特定のグループに属しているすべてのホストにパケットを送信するために利用される  
IPをそのまま利用するので、信頼性はない  
ブロードキャストでは、どうしても無駄な受信、パケットの破棄などが発生して合理的な通信方法ではなかった  
そこで、マルチキャストを採用してルーターを越えて特定のセグメントに属しているホストのみにパケットを送信することが主流になった  
#### IPマルチキャストとアドレス
IPマルチキャストでは、クラスDのIPアドレスを使用する  
つまり、先頭から4ビットまでが**1110**であればマルチキャストアドレスとして認識され、残りの28ビットがマルチキャストの対象となるグループ番号になる  
IPマルチキャストを使って実用的な通信をしようとすると**IGMP(5.8.2項参照)などの仕組み**が必要になる  
### 4.3.6 サブネットマスク
#### サブネットワークとサブネットマスク、ネットワークプレフィックス
現在サブネットマスクという識別子で、クラスA,B,Cのネットワークを小さく区切れるサブネットワークアドレスが利用できる  
IPアドレスのホスト部を管理することで、クラスごとに決まるホスト部をサブネットワークアドレス部として扱うことで、複数の物理ネットワークに分割できるようにする仕組み  
これによりIPアドレスは2つの識別子（IPアドレスとサブネットマスク）で表せる  
サブネットマスクはIPアドレスと同じ32ビットでIPアドレスのネットワーク部を表すビットと同じ桁の部分が1になりホスト部を表すビットと同じ部分が0になる  
IPアドレスの後ろに/を書き、その後ろにネットワークアドレスが先頭から何ビットめまでなのかを書く**プレフィックス**という書き方がある
### 4.3.7 CIDRとVLSM
CIDRは、IPアドレスのクラス分けを廃止して任意のビット長でIPアドレスを配布すること  
CIDRは「クラスに縛られない組織間の経路制御」を意味する  
CIDRの場合、組織の全ネットワーク内を決められたビット長に統一する必要があり、効率的なネットワークを構築できなかった  
そこで、VLSMが登場し、可変長のビット長を変えられるようにする仕組みが出てきた  
これはルーティングプロトコルをRIP2（7.4.5項参照）やOSPF(7.5項)に変更することで実現した  
### 4.3.8 グローバルアドレスとプライベートアドレス
インターネットの急速な普及で、IPアドレスの枯渇が始まった  
そこでインターネットに繋がない独立したネットワークはそのネットワーク内でユニークであれば良く、インターネットとは無関係にIPアドレスを割り振ることもできる
それでは好き勝手にIPアドレスを使えてしまうため、プライベートIPアドレスが誕生した  
プライベートIPアドレスは次の範囲になる  
```
10.0.0.0 ~ 10.255.255.255 (10/8) クラスA  
172.16.0.0 ~ 172.31.255.255 (172.16/12) クラスB  
192.168.0.0 ~ 192.168.255.255 (192.168/16) クラスC  
```
プライベートIPアドレスは当初インターネットとの接続を考えない用途で利用されていた  
しかし、その後プライベートIPアドレスとグローバルIPアドレスの間でアドレスを変換する**NAT**が誕生し、プライベートアドレスを割り当てたネットワーク上のホストからグローバルアドレスを割り当てたインターネット上のホストと通信ができるようになった  
現在ではホストにはプライベートアドレスを設定し、インターネットに接続するルーターや、インターネットに公開しているサーバーにだけグローバルアドレスを設定していることが一般的になった  
## 4.4 経路制御（ルーティング）
### 4.4.1 IPアドレスと経路制御（ルーティング）
ルーティングテーブルに同じネットワークアドレスがあるときは、一致するビット長が長い方のネットワークアドレスを選択する、これを最長一致という  
例えば、172.20.100.52は、172.20/16と172.20.100/24どちらにでもマッチする、この場合はビット列の長い172.20.100/24を選択する  
#### デフォルトルート
すべてのネットワークやサブネットの情報をルーティングテーブルに詰め込むと無駄が多い  
そのためデフォルトルートが利用されていて、ルーティングテーブルに登録されているどのアドレスにも**マッチしない**場合の経路を指す  
デフォルトルートは0.0.0.0/0またはdefaultと記述するが、経路処理では0.0.0.0/0で処理される  
#### ホストルート
IPアドレス/32がホストルートと呼ばれる(ex: 192.168.153.15/32)はホストルート  
これはIPアドレスのすべてのビットを使って経路制御するという意味  
このホストルートをつかうとIPアドレスのネットワーク部ではなく、ネットワークインターフェースにつけたIPアドレスそのものに基づいた経路制御がされる  
ホストルートは、何らかの都合によりネットワークアドレスによる経路制御を利用したくない場合につかわれるが、ホストルートはルーティングテーブルが大きくなりルーターの負荷が増大してネットワークの性能が低下する原因になるので注意  
#### ループバックアドレス
いわゆるlocalhostのこと、172.0.0.1というIPアドレスを使っている  
ローカルで、自分のプログラムを動かす時によく使っているアドレス、当然だがパケットはネットワークに流れない  
#### リンクローカルアドレス
ルーターを越えない同一リンク内の通信のために169.254/16のアドレスがつかわれる  
これは固定IPが設定されていないホストでDHCPによるIPアドレスの取得ができなかったときに設定されることがある  
ホスト部はランダムに設定される(もちろんIPアドレスが重複しないようにARPで確認したうえでIPアドレスを決定する)、これをリンクローカルアドレスと呼び、ルーターによる転送を禁止にする  
### 4.4.2 経路制御表の集約
ネットワークアドレスのビットのパターンを考えて階層的に配置すると、内部では複数のネットワークから構成されていても外部からは1つのネットワークアドレスでルーティングすることができる  
このようにネットワークを構築するとルーティングテーブルを小さくすることができる  
小さくすると、メモリやCPUのパワーがその分いらなくなり、検索の時間も短縮され、IPパケットの転送能力が向上する  
さらに集約することで自分が知っている経路情報を周囲のルーターに伝えるときにその情報を少なくする抑えられるという重要な意味がある  
ルーターは自分が「192.168.2.0/24, 192.168.3.0/24を知っている」ことを「192.168.2.0/23を知っている」と集約して知らせることができる  
## 4.5 IPの分割処理と再構築処理
### 4.5.2 IPデータグラムの分割処理と再構築処理
ホストやルーターは必要に応じてIPデータグラムのフラグメンテーション(分割処理)をしなければなりません  
これはMTUよりも大きいパケット量が送られたときに行われる  
これは、ルーター側で送信可能なMTUのパケットに分けて行っているとルーターの負荷がましてしまうなどの問題が生じる  
#### 4.5.3 経路MTU探索(Path MTU Discovery)
そこで、経路MTU探索という技術が誕生した  
これは送信元ホストから宛先ホストまでの経路に存在する最小のMTUを調べて、事前にそのMTUに合わせたパケットに分割し送ってしまおうという仕組み  
こうすることで、途中ルーターでフラグメンテーションをする必要がなくなる  
##### 余談 TCPの経路MTU探索
TCPの場合には、経路MTUの大きさをもとに最大セグメント長（MSS）の値を再計算し、それをもとにパケットの送信が行われる  
そのため、TCPでフラグメンテーションした場合、IPでは行われない  
# 5 IPに関する技術
## 5.1 IPだけでは通信できない
IPパケットを使って通信するためにはアプリケーションで使用するアドレスからIPアドレスを知る必要がある  
データリンクではIPアドレスではなく、MACアドレスが使われる  
実際にIPパケットをネットワーク上で選ぶのはデータリンクなので、送り先のMACアドレスの情報が分かる必要がある  
## 5.2 DNS（Domain Name System）
### 5.2.2 DNSの登場
ホスト名とIPアドレスの対応関係を効率よく管理するための手段としてDNSが考えられた
### 5.2.3 ドメイン名の構造
DNSの仕組みを理解するにはドメイン名を理解する必要がある  
ドメイン名とはホストの名前や組織の名前を識別するための階層的な名前  
#### リゾルバ(Resolver)
DNSに問い合わせをおこなうホストやソフトウェアをリゾルバという  
ユーザーが利用するワークステーションやパソコンはリゾルバにあたる  
リゾルバは最低でも1つ以上のネームサーバーのIPアドレスを知らなければならない  
通常はその組織内のネームサーバーのIPアドレスを登録する  
### 5.2.5 DNSはインターネットに広がる分散データベース
DNSは、ホスト名からIPアドレスを検索するシステムであるが、管理しているデータはそれだけではない  
ホスト名とIPアドレスの対応はAレコード,その逆のIPアドレスからホスト名を検索するときのPTRレコード、メールアドレスとそのメールを受信するメールサーバーのホスト名が登録されるMXレコードなども管理している  
## 5.3 ARP(Address Resolution Protocol)
IPアドレスが決まれた宛先IPアドレスに向けてIPデータグラムを送信することができる  
しかし、実際にデータリンクを利用して通信するときは、そのIPアドレスに対応したMACアドレスを知っておかないといけない  
### 5.3.1 ARPの概要
ARPは、アドレス解決のためのプロトコルである  
宛先IPアドレスから次にパケットを受け取るべき機器のMACアドレスを知りたいときに利用する  
宛先のホストが同一リンク上にない場合には、次ホップのルーターのMACアドレスをARPで調べることになる  
(ARPはIPv4でのみ利用され、IPv6では利用されないIPv6ではICMPv6の近隣探索メッセージが利用される)  
### 5.3.2 ARPの仕組み
ARPはどのようにしてMACアドレスを知るのか  
ARPでは**ARP要求パケット**と**ARP応答パケット**の2種類のパケットを利用してMACアドレスを知る  
例として、ホストAが同一リンク上のホストBにIPパケットを送信したい状態とする  
ホストAのIPアドレスは172.20.1.1で、ホストBのIPアドレスは172.20.1.2だが、ホストAはホストBのMACアドレスを知らない  
1. ホストAはホストBのMACアドレスを入手するために、最初にARP要求パケットをブロードキャストする(このパケットの中にはMACアドレスを知りたいIPアドレスが入っている)  
2. ブロードキャストされたパケットは同一リンク上のすべてのホストやルーターが受信  
3. 受信したホストは、パケットの内容を解析し目的のIPアドレスが自分のIPアドレスに一致した場合は、自分のMACアドレスを埋めたARP応答パケットをホストA宛に返送する  
ARPによるアドレスの解決は動的に行われるので、TCP/IPによってネットワークを構築または通信するときにはMACアドレスを意識する必要がなく、IPアドレスのみを考えればよいことになる  
一度ARPによって解決されたMACアドレスは数分間キャッシュされるので、2回目からはARPではなくキャッシュからMACアドレスを取得できるようになっている  
キャッシュには、ARP要求パケットを送ってきたIPアドレスとMACアドレスもキャッシュされる  
そのキャッシュをもとにARP応答パケットを返送する流れになっている  
### 5.3.4 RARP(Reverse Address Resolution Protocol)
RARPはARPの逆でMACアドレスからIPアドレスを知りたい場合に使われる  
ふだん使用しているスマホやパソコンの場合DHCPを使って自動的にIPアドレスが設定される  
### 5.3.5 Gratuitous ARP (GARP)
GARPは自分のMACアドレスを知りたいというARP**パケット**のこと  
つまり、自分のIPアドレスをターゲットにして、この機器のMACアドレスを教えてくれというARP要求パケットが流れるということ  
なぜそんなパケットを作る必要があるのか、それはIPアドレスの**重複を検知するため**  
これが面白い、もしARP要求パケットを送っても返答がない＝自分のIPアドレスは重複していないということ  
さらに途中のスイッチング・ハブなどのMACアドレス学習テーブルを更新させる働きもある  
これは自分のIPアドレスとMACアドレスの対応関係が変わったときなどに使われる
### 5.3.6 代理ARP（Proxy ARP）
通常のARPは同一セグメント内（サブネット）内でIPパケットを配送するときに使われるが、代理ARPはルーティングテーブルを使わずにIPパケットを別のセグメントに送りたい場合に使われる  
